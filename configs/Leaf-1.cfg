!
! Leaf-1 Configuration
! BGP EVPN VXLAN - 3-Tier Clos Topology
! VTEP with VRF mylab, VLANs 10/20/30/40, Anycast Gateway
!

hostname Leaf-1

! Enable required features
feature bgp
feature interface-vlan
feature vn-segment-vlan-based
feature nv overlay
feature fabric forwarding

! Anycast Gateway MAC (same on all Leafs)
fabric forwarding anycast-gateway-mac 0000.1111.2222

! VRF Definition
vrf context mylab
  vni 50000
  rd auto
  address-family ipv4 unicast
    route-target both auto
    route-target both auto evpn

! VLAN Definitions
vlan 10
  name VLAN10_Data
  vn-segment 10010

vlan 20
  name VLAN20_Voice
  vn-segment 10020

vlan 30
  name VLAN30_Management
  vn-segment 10030

vlan 40
  name VLAN40_Guest
  vn-segment 10040

vlan 100
  name L3VNI_mylab
  vn-segment 50000

! Loopbacks
interface loopback0
  description BGP Router-ID
  ip address 10.0.2.1/32

interface loopback1
  description VTEP Source
  ip address 10.0.2.1/32

! SVI for L3VNI (VRF routing)
interface Vlan100
  description L3VNI for VRF mylab
  no shutdown
  vrf member mylab
  ip forward

! SVIs with Anycast Gateway
interface Vlan10
  description VLAN 10 - Anycast Gateway
  no shutdown
  vrf member mylab
  ip address 192.168.10.1/24
  fabric forwarding mode anycast-gateway

interface Vlan20
  description VLAN 20 - Anycast Gateway
  no shutdown
  vrf member mylab
  ip address 192.168.20.1/24
  fabric forwarding mode anycast-gateway

interface Vlan30
  description VLAN 30 - Anycast Gateway
  no shutdown
  vrf member mylab
  ip address 192.168.30.1/24
  fabric forwarding mode anycast-gateway

interface Vlan40
  description VLAN 40 - Anycast Gateway
  no shutdown
  vrf member mylab
  ip address 192.168.40.1/24
  fabric forwarding mode anycast-gateway

! NVE Interface (VTEP)
interface nve1
  no shutdown
  host-reachability protocol bgp
  source-interface loopback1
  member vni 10010
    suppress-arp
    ingress-replication protocol bgp
  member vni 10020
    suppress-arp
    ingress-replication protocol bgp
  member vni 10030
    suppress-arp
    ingress-replication protocol bgp
  member vni 10040
    suppress-arp
    ingress-replication protocol bgp
  member vni 50000 associate-vrf

! Uplinks to Spines
interface Ethernet1/1
  description To Spine-1 E1/1
  no switchport
  mtu 9216
  ip address 10.2.1.1/31
  no shutdown

interface Ethernet1/2
  description To Spine-2 E1/1
  no switchport
  mtu 9216
  ip address 10.2.2.1/31
  no shutdown

interface Ethernet1/3
  description To Spine-3 E1/1
  no switchport
  mtu 9216
  ip address 10.2.3.1/31
  no shutdown

interface Ethernet1/4
  description To Spine-4 E1/1
  no switchport
  mtu 9216
  ip address 10.2.4.1/31
  no shutdown

! BGP Configuration
router bgp 65101
  router-id 10.0.2.1
  bestpath as-path multipath-relax
  log-neighbor-changes
  address-family ipv4 unicast
    redistribute direct route-map PERMIT-ALL
    maximum-paths 64
  address-family l2vpn evpn

  ! VRF mylab BGP
  vrf mylab
    address-family ipv4 unicast
      advertise l2vpn evpn
      redistribute direct route-map PERMIT-ALL
      maximum-paths 64

  ! Uplinks to Spines
  neighbor 10.2.1.0
    remote-as 65001
    description Spine-1
    update-source Ethernet1/1
    address-family ipv4 unicast
    address-family l2vpn evpn
      send-community extended

  neighbor 10.2.2.0
    remote-as 65002
    description Spine-2
    update-source Ethernet1/2
    address-family ipv4 unicast
    address-family l2vpn evpn
      send-community extended

  neighbor 10.2.3.0
    remote-as 65003
    description Spine-3
    update-source Ethernet1/3
    address-family ipv4 unicast
    address-family l2vpn evpn
      send-community extended

  neighbor 10.2.4.0
    remote-as 65004
    description Spine-4
    update-source Ethernet1/4
    address-family ipv4 unicast
    address-family l2vpn evpn
      send-community extended

! EVPN Configuration
evpn
  vni 10010 l2
    rd auto
    route-target import auto
    route-target export auto
  vni 10020 l2
    rd auto
    route-target import auto
    route-target export auto
  vni 10030 l2
    rd auto
    route-target import auto
    route-target export auto
  vni 10040 l2
    rd auto
    route-target import auto
    route-target export auto

! Route-maps
route-map PERMIT-ALL permit 10

end
