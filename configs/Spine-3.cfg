!
! Spine-3 Configuration
! BGP EVPN VXLAN - 3-Tier Clos Topology
!

hostname Spine-3

! Enable required features
feature bgp
feature interface-vlan
feature lacp
feature nv overlay

! Loopback for BGP Router-ID
interface loopback0
  description BGP Router-ID
  ip address 10.0.1.3/32

! Uplinks to Super-Spines
interface Ethernet1/5
  description To Super-Spine-1 E1/3
  no switchport
  mtu 9216
  ip address 10.1.1.5/31
  no shutdown

interface Ethernet1/6
  description To Super-Spine-2 E1/3
  no switchport
  mtu 9216
  ip address 10.1.2.5/31
  no shutdown

! Downlinks to Leafs
interface Ethernet1/1
  description To Leaf-1 E1/3
  no switchport
  mtu 9216
  ip address 10.2.3.0/31
  no shutdown

interface Ethernet1/2
  description To Leaf-2 E1/3
  no switchport
  mtu 9216
  ip address 10.2.3.2/31
  no shutdown

interface Ethernet1/3
  description To Leaf-3 E1/3
  no switchport
  mtu 9216
  ip address 10.2.3.4/31
  no shutdown

interface Ethernet1/4
  description To Leaf-4 E1/3
  no switchport
  mtu 9216
  ip address 10.2.3.6/31
  no shutdown

! BGP Configuration
router bgp 65003
  router-id 10.0.1.3
  bestpath as-path multipath-relax
  log-neighbor-changes
  address-family ipv4 unicast
    redistribute direct route-map PERMIT-ALL
    maximum-paths 64
  address-family l2vpn evpn
    retain route-target all

  ! Uplink to Super-Spines
  neighbor 10.1.1.4
    remote-as 65000
    description Super-Spine-1
    update-source Ethernet1/5
    address-family ipv4 unicast
    address-family l2vpn evpn
      send-community extended
      route-map UNCHANGED out

  neighbor 10.1.2.4
    remote-as 65000
    description Super-Spine-2
    update-source Ethernet1/6
    address-family ipv4 unicast
    address-family l2vpn evpn
      send-community extended
      route-map UNCHANGED out

  ! Downlinks to Leafs
  neighbor 10.2.3.1
    remote-as 65101
    description Leaf-1
    update-source Ethernet1/1
    address-family ipv4 unicast
    address-family l2vpn evpn
      send-community extended
      route-map UNCHANGED out

  neighbor 10.2.3.3
    remote-as 65102
    description Leaf-2
    update-source Ethernet1/2
    address-family ipv4 unicast
    address-family l2vpn evpn
      send-community extended
      route-map UNCHANGED out

  neighbor 10.2.3.5
    remote-as 65103
    description Leaf-3
    update-source Ethernet1/3
    address-family ipv4 unicast
    address-family l2vpn evpn
      send-community extended
      route-map UNCHANGED out

  neighbor 10.2.3.7
    remote-as 65104
    description Leaf-4
    update-source Ethernet1/4
    address-family ipv4 unicast
    address-family l2vpn evpn
      send-community extended
      route-map UNCHANGED out

! Route-maps
route-map PERMIT-ALL permit 10

route-map UNCHANGED permit 10
  set ip next-hop unchanged

end
